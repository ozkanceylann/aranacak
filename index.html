<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aranacaklar</title>

<style>
  body {
    font-family: Arial, sans-serif;
    background: #f0f0f0;
    margin: 0;
    padding: 15px;
  }

  .card {
    background: #fff;
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    cursor: pointer;
  }

  .row-main {
    font-size: 17px;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
  }

  .row-main small {
    color: #555;
    font-size: 15px;
    font-weight: normal;
  }

  .details {
    margin-top: 12px;
    font-size: 14px;
    display: none;
  }

  .tag {
    background: #27ae60;
    padding: 3px 8px;
    border-radius: 5px;
    color: white;
    font-size: 12px;
    margin-top: 8px;
    display: inline-block;
  }

  .btn {
    background: #2ecc71;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 10px;
  }

  .btn:disabled {
    background: gray;
    cursor: not-allowed;
  }
</style>
</head>

<body>

<button onclick="logout()" class="btn">Ã‡Ä±kÄ±ÅŸ</button>

<h2>ðŸ“ž Aranacaklar</h2>
<div id="list"></div>

<script>
/* LOGIN KONTROL */
const userRaw = localStorage.getItem("user");
if (!userRaw) {
  window.location.href = "login.html";
}
const currentUser = JSON.parse(userRaw);
</script>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
function formatPhone(raw) {
  if (!raw) return "";

  let num = raw.replace(/\D/g, "");

  if (num.startsWith("9") && num.length >= 11) {
    num = num.substring(1);
  }

  if (num.length > 10) num = num.slice(-10);

  return num.replace(/(\d{3})(\d{3})(\d{2})(\d{2})/, "0$1 $2 $3 $4");
}

function telLink(raw) {
  let num = raw.replace(/\D/g, "");

  if (num.startsWith("9") && num.length >= 11) {
    num = num.substring(1);
  }

  if (num.length > 10) num = num.slice(-10);

  return "0" + num;
}

/* ===========================
   1) SUPABASE BAÄžLANTISI
=========================== */
const SUPABASE_URL = "https://jarsxtpqzqzhlshpmgot.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphcnN4dHBxenF6aGxzaHBtZ290Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyODExMTcsImV4cCI6MjA3Nzg1NzExN30.98oYONSkb8XSDrfGW2FxhFmt2BLB5ZRo3Ho50GhZYgE";

const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ===========================
   2) VERÄ°LERÄ° Ã‡EK
=========================== */
async function fetchList() {
  const { data, error } = await client
    .from("aranacaklar")
    .select("*")
    .eq("arandi", true)                          // sadece arananlar
    .order("arama_zamani", { ascending: false }) // en son arananlar
    .limit(10);                                  // sadece son 10 kayÄ±t

  if (error) {
    console.error("Supabase HatasÄ±:", error);
    return;
  }

  renderList(data);
}

/* ===========================
   3) LÄ°STEYÄ° OLUÅžTUR
=========================== */
function renderList(data) {
  const container = document.getElementById("list");
  container.innerHTML = "";

  data.forEach(item => {
    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <div class="row-main">
        <span>${item.ad_soyad ?? 'Ä°simsiz'}</span>
        <small>
          <a href="tel:${telLink(item.musteri_tel)}" style="text-decoration:none; color:#555;">
            ${formatPhone(item.musteri_tel)}
          </a>
        </small>
      </div>

      ${item.arandi ? `<div class="tag">ArandÄ± (${item.arayan ?? "-"})</div>` : ""}

      <div class="details">
        <p><b>Adres:</b> ${item.adres ?? '-'}</p>
        <p><b>Åžehir:</b> ${item.sehir ?? '-'}</p>
        <p><b>Ä°lÃ§e:</b> ${item.ilce ?? '-'}</p>
        <p><b>ÃœrÃ¼n:</b> ${item.urun ?? '-'}</p>
        <p><b>KayÄ±t:</b> ${item.tarih ?? '-'}</p>

        <button class="btn"
          ${item.arandi ? "disabled" : ""}
          onclick="markAsCalled(event, ${item.row_no})">
          ArandÄ± Olarak Ä°ÅŸaretle
        </button>
      </div>
    `;

    card.addEventListener("click", function(e) {
      if (e.target.classList.contains("btn")) return;
      const details = this.querySelector(".details");
      details.style.display = details.style.display === "block" ? "none" : "block";
    });

    container.appendChild(card);
  });
}

function logout() {
  localStorage.removeItem("user");
  window.location.href = "login.html";
}

/* ===========================
   4) ARANDI GÃœNCELLE (ARAYAN EKLENDÄ°)
=========================== */
async function markAsCalled(event, row_no) {
  event.stopPropagation();

  const { error: err1 } = await client
    .from("aranacaklar")
    .update({
      arandi: true,
      arama_zamani: new Date().toISOString(),
      arayan: currentUser.username
    })
    .eq("row_no", row_no);

  if (err1) {
    console.error("Aranacaklar gÃ¼ncelleme hatasÄ±:", err1);
    return;
  }

  const { error: err2 } = await client
    .from("musteriler_shn")
    .update({ arama: true })
    .eq("row_no", row_no);

  if (err2) {
    console.error("Musteriler tablosu gÃ¼ncelleme hatasÄ±:", err2);
    return;
  }

  event.target.closest(".card").remove();

  if (document.querySelectorAll(".card").length === 0) {
    fetchList();
  }
}

/* Sayfa aÃ§Ä±lÄ±nca listeyi Ã§ek */
fetchList();
</script>

</body>
</html>
